{% extends 'admin_template/base.html' %}
{% load static %}

{% block title %}Rapport Juridiction{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="container-full">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="d-flex align-items-center">
                <div class="me-auto">
                    <h3 class="page-title">Rapport Juridiction</h3>
                    <div class="d-inline-block align-items-center">
                        <nav>
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'Dashboard_Cabinet_Administrateur' %}"><i class="mdi mdi-home-outline"></i></a></li>
                                <li class="breadcrumb-item">Rapport</li>
                                <li class="breadcrumb-item active" aria-current="page">Juridiction</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h4 class="box-title">
                                <i class="mdi mdi-bank text-primary"></i> 
                                Liste des Juridictions ({{ total_juridictions }})
                            </h4>
                            <div class="box-tools">
                                <button type="button" class="btn btn-success btn-sm" onclick="imprimerRapportFiltre()">
                                    <i class="mdi mdi-printer"></i> Imprimer
                                </button>
                            </div>
                        </div>
                        
                        <div class="box-body">
                            <!-- Statistiques rapides -->
                            <div class="row mb-4">
                                <div class="col-lg-6 col-6">
                                    <div class="small-box bg-info">
                                        <div class="inner">
                                            <h3>{{ total_juridictions }}</h3>
                                            <p>Total Juridictions</p>
                                        </div>
                                        <div class="icon">
                                            <i class="mdi mdi-bank"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-6">
                                    <div class="small-box bg-success">
                                        <div class="inner">
                                            <h3 id="juridictions-actives">0</h3>
                                            <p>Juridictions Actives</p>
                                        </div>
                                        <div class="icon">
                                            <i class="mdi mdi-check-circle"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Filtres -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Filtrer par lieu:</label>
                                        <select id="filtre-lieu" class="form-control">
                                            <option value="">Tous les lieux</option>
                                            {% for item in juridictions_data %}
                                                {% if item.lieu_nom not in lieux_vus %}
                                                    <option value="{{ item.lieu_nom }}">{{ item.lieu_nom }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Rechercher:</label>
                                        <input type="text" id="recherche-juridiction" class="form-control" placeholder="Nom de juridiction...">
                                    </div>
                                </div>
                            </div>

                            <!-- Tableau des juridictions -->
                            <div class="table-responsive">
                                <table id="tableau-juridictions" class="table table-bordered table-striped">
                                    <thead class="bg-primary text-white">
                                        <tr>
                                            <th>ID</th>
                                            <th>Nom Juridiction</th>
                                            <th>Lieu</th>
                                            <th>Date Création</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in juridictions_data %}
                                        <tr data-lieu="{{ item.lieu_nom }}" data-statut="Actif" data-juridiction-id="{{ item.juridiction.id }}">
                                            <td class="text-center">
                                                <strong>{{ item.juridiction.id }}</strong>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <strong>{{ item.juridiction.nom }}</strong>
                                                    <small class="text-muted">Juridiction</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-info">{{ item.lieu_nom }}</span>
                                            </td>
                                            <td>{{ item.juridiction.date_creation|date:"d/m/Y"|default:"-" }}</td>
                                            <td>
                                                <span class="badge badge-success">
                                                    <i class="mdi mdi-check-circle"></i> Actif
                                                </span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="mdi mdi-information"></i> Aucune juridiction trouvée
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Modal Détails Juridiction -->
<div class="modal fade" id="modalDetailsJuridiction" tabindex="-1" aria-labelledby="modalDetailsJuridictionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetailsJuridictionLabel">
                    <i class="mdi mdi-bank"></i> Détails de la Juridiction
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenu-details-juridiction">
                <div class="text-center">
                    <i class="mdi mdi-loading mdi-spin"></i> Chargement...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="genererRapportJuridictionModal()">
                    <i class="mdi mdi-file-document"></i> Générer Rapport
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let juridictionSelectionnee = null;

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    calculerStatistiques();
    initialiserFiltres();
});

// Calculer les statistiques
function calculerStatistiques() {
    const lignes = document.querySelectorAll('#tableau-juridictions tbody tr[data-juridiction-id]');
    let juridictionsActives = 0;
    
    lignes.forEach(ligne => {
        const statut = ligne.getAttribute('data-statut');
        
        if (statut === 'Actif') {
            juridictionsActives++;
        }
    });
    
    document.getElementById('juridictions-actives').textContent = juridictionsActives;
}

// Initialiser les filtres
function initialiserFiltres() {
    const filtreLieu = document.getElementById('filtre-lieu');
    const rechercheJuridiction = document.getElementById('recherche-juridiction');
    
    [filtreLieu, rechercheJuridiction].forEach(element => {
        element.addEventListener('change', appliquerFiltres);
        element.addEventListener('keyup', appliquerFiltres);
    });
}

// Appliquer les filtres
function appliquerFiltres() {
    const filtreLieu = document.getElementById('filtre-lieu').value.toLowerCase();
    const recherche = document.getElementById('recherche-juridiction').value.toLowerCase();
    
    const lignes = document.querySelectorAll('#tableau-juridictions tbody tr[data-juridiction-id]');
    
    lignes.forEach(ligne => {
        const lieu = ligne.getAttribute('data-lieu').toLowerCase();
        const texte = ligne.textContent.toLowerCase();
        
        const correspondLieu = !filtreLieu || lieu.includes(filtreLieu);
        const correspondRecherche = !recherche || texte.includes(recherche);
        
        if (correspondLieu && correspondRecherche) {
            ligne.style.display = '';
        } else {
            ligne.style.display = 'none';
        }
    });
}

// Voir détails d'une juridiction
function voirDetailsJuridiction(juridictionId) {
    juridictionSelectionnee = juridictionId;
    
    // Simuler le chargement des détails (à implémenter avec AJAX)
    document.getElementById('contenu-details-juridiction').innerHTML = `
        <div class="row">
            <div class="col-md-4 text-center">
                <div class="avatar avatar-xl bg-primary rounded-circle mx-auto mb-3">
                    <i class="mdi mdi-bank fs-1 text-white"></i>
                </div>
                <h5>Juridiction #${juridictionId}</h5>
            </div>
            <div class="col-md-8">
                <h6>Informations générales</h6>
                <p><strong>Nom:</strong> Juridiction ${juridictionId}</p>
                <p><strong>Lieu:</strong> Lieu de la juridiction</p>
                <p><strong>Date création:</strong> Date de création</p>
                
                <h6 class="mt-3">Informations complémentaires</h6>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <strong>Actif</strong><br>
                            <small>Statut</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <strong>Cabinet</strong><br>
                            <small>Rattachement</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetailsJuridiction'));
    modal.show();
}

// Générer rapport d'une juridiction
function genererRapportJuridiction(juridictionId) {
    // Ouvrir directement le PDF comme pour les agents et clients
    const typeRapport = 'complet'; // Par défaut
    const urlImpression = `/rapport/juridiction/imprimer/${juridictionId}/?type=${typeRapport}`;
    
    // Ouvrir le PDF dans un nouvel onglet
    window.open(urlImpression, '_blank');
    
    // Notification
    toastr.success('Rapport généré avec succès !', 'Succès');
}

// Générer rapport depuis le modal
function genererRapportJuridictionModal() {
    if (juridictionSelectionnee) {
        genererRapportJuridiction(juridictionSelectionnee);
    }
}

// Imprimer rapport d'une juridiction
function imprimerRapportJuridiction(juridictionId) {
    // Même fonction que générer rapport (impression directe)
    genererRapportJuridiction(juridictionId);
}

// Exporter le tableau
function exporterTableau(format) {
    // Rediriger vers la nouvelle fonction d'impression
    if (format === 'pdf') {
        imprimerRapportFiltre('complet');
    } else {
        alert('Export Excel à implémenter');
    }
}

// Imprimer rapport avec filtres appliqués (même logique que les autres rapports)
function imprimerRapportFiltre(typeRapport = 'complet') {
    // Récupérer les juridictions visibles (après filtrage)
    const lignesVisibles = document.querySelectorAll('#tableau-juridictions tbody tr[data-juridiction-id]:not([style*="display: none"])');
    
    if (lignesVisibles.length === 0) {
        alert('Aucune juridiction visible à imprimer. Vérifiez vos filtres.');
        return;
    }
    
    // Extraire les IDs des juridictions visibles
    const juridictionsIds = Array.from(lignesVisibles).map(ligne => 
        ligne.getAttribute('data-juridiction-id')
    );
    
    // Récupérer les filtres appliqués
    const filtreLieu = document.getElementById('filtre-lieu') ? document.getElementById('filtre-lieu').value : '';
    const recherche = document.getElementById('recherche-juridiction') ? document.getElementById('recherche-juridiction').value : '';
    
    // Créer un formulaire pour envoyer les données en POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/rapport/juridiction/imprimer-filtre/';
    form.target = '_blank'; // Ouvrir dans un nouvel onglet
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
    }
    
    // Ajouter les IDs des juridictions
    juridictionsIds.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'juridictions_ids[]';
        input.value = id;
        form.appendChild(input);
    });
    
    // Ajouter les filtres
    const filtres = [
        { name: 'filtre_lieu', value: filtreLieu },
        { name: 'recherche', value: recherche }
    ];
    
    filtres.forEach(filtre => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = filtre.name;
        input.value = filtre.value;
        form.appendChild(input);
    });
    
    // Ajouter le formulaire au DOM et le soumettre
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}
</script>

<style>
.small-box {
    border-radius: 10px;
    position: relative;
    display: block;
    margin-bottom: 20px;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
}

.small-box > .inner {
    padding: 10px;
}

.small-box > .small-box-footer {
    position: relative;
    text-align: center;
    padding: 3px 0;
    color: #fff;
    color: rgba(255,255,255,0.8);
    display: block;
    z-index: 10;
    background: rgba(0,0,0,0.1);
    text-decoration: none;
}

.small-box > .small-box-footer:hover {
    color: #fff;
    background: rgba(0,0,0,0.15);
}

.small-box .icon {
    -webkit-transition: all .3s linear;
    -o-transition: all .3s linear;
    transition: all .3s linear;
    position: absolute;
    top: -10px;
    right: 10px;
    z-index: 0;
    font-size: 90px;
    color: rgba(0,0,0,0.15);
}

.small-box:hover {
    text-decoration: none;
    color: #f9f9f9;
}

.small-box:hover .icon {
    font-size: 95px;
}

.bg-info {
    background-color: #17a2b8 !important;
    color: white;
}

.bg-success {
    background-color: #28a745 !important;
    color: white;
}

.bg-warning {
    background-color: #ffc107 !important;
    color: white;
}

.bg-danger {
    background-color: #dc3545 !important;
    color: white;
}

.avatar {
    width: 40px;
    height: 40px;
}

.avatar-sm {
    width: 32px;
    height: 32px;
}

.avatar-xl {
    width: 80px;
    height: 80px;
}
</style>
{% endblock %}